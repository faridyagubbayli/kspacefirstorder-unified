name: CI (multi-platform)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  linux-openmp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Install system dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake pkg-config \
            libhdf5-dev libfftw3-dev
      - name: Build (OpenMP, Linux)
        run: |
          set -euxo pipefail
          cd repos/kspaceFirstOrder-openmp-linux
          # Try a clean build exactly like the working local command
          if make -j"$(nproc)" all \
              LINKING=DYNAMIC COMPILER=GNU \
              EBROOTHDF5=/usr/lib/x86_64-linux-gnu/hdf5/serial \
              EBROOTZLIB=/usr EBROOTFFTW=/usr EBROOTSZIP=/usr \
              LIB_PATHS='-L/usr/lib/x86_64-linux-gnu/hdf5/serial/lib -L/usr/lib/x86_64-linux-gnu'
          then
            echo "Built successfully without adjustments."
          else
            echo "Falling back: wrapper to set space recipe prefix before parsing"
            printf '.RECIPEPREFIX := \x20\ninclude Makefile\n' > Makefile.ci
            make -f Makefile.ci -j"$(nproc)" all \
                LINKING=DYNAMIC COMPILER=GNU \
                EBROOTHDF5=/usr/lib/x86_64-linux-gnu/hdf5/serial \
                EBROOTZLIB=/usr EBROOTFFTW=/usr EBROOTSZIP=/usr \
                LIB_PATHS='-L/usr/lib/x86_64-linux-gnu/hdf5/serial/lib -L/usr/lib/x86_64-linux-gnu'
          fi
      - name: Smoke test (Linux)
        run: |
          set -euxo pipefail
          cd repos/kspaceFirstOrder-openmp-linux
          chmod +x ./kspaceFirstOrder-OMP || true
          LD_LIBRARY_PATH="/usr/lib/x86_64-linux-gnu/hdf5/serial:${LD_LIBRARY_PATH:-}" ./kspaceFirstOrder-OMP --help | head -n 40 || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kspaceFirstOrder-openmp-linux-ubuntu-latest
          path: |
            repos/kspaceFirstOrder-openmp-linux/kspaceFirstOrder-*
          if-no-files-found: error

      - name: Build diagnostics
        if: failure()
        run: |
          echo "Build failed for OpenMP (Linux)"
          echo "CPU info:"; lscpu || true
          echo "FFTW libs:"; ldconfig -p | grep -i fftw || true
          echo "HDF5 libs:"; ldconfig -p | grep -i hdf5 || true

  linux-cuda:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        cuda-version: ['12.2.0', '13.0.0']
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Install system dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential pkg-config \
            gcc-12 g++-12 \
            libhdf5-dev zlib1g-dev libfftw3-dev
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 120
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 120
          sudo update-alternatives --set gcc /usr/bin/gcc-12
          sudo update-alternatives --set g++ /usr/bin/g++-12
          gcc --version
          g++ --version

      - name: Install CUDA Toolkit (Linux)
        uses: N-Storm/cuda-toolkit@v0.2.27m
        with:
          cuda: ${{ matrix.cuda-version }}
          use-github-cache: true
          method: local
          linux-local-args: '["--toolkit"]'
          use-local-cache: false
          log-file-suffix: ${{ matrix.cuda-version }}.log.txt

      - name: Build (CUDA, Linux)
        run: |
          set -euxo pipefail
          export CC=/usr/bin/gcc-12 CXX=/usr/bin/g++-12 CUDAHOSTCXX=/usr/bin/g++-12
          cd repos/kspaceFirstOrder-cuda-linux
          # Try a straight build first (as done locally)
          if make -j"$(nproc)" all \
               LINKING=DYNAMIC COMPILER=GNU \
               CUDA_HOME=/usr/local/cuda \
               EBROOTHDF5=/usr/lib/x86_64-linux-gnu/hdf5/serial \
               EBROOTZLIB=/usr EBROOTFFTW=/usr EBROOTSZIP=/usr
          then
            echo "CUDA build succeeded."
          else
            echo "Falling back: set space recipe prefix via wrapper"
            printf '.RECIPEPREFIX := \x20\ninclude Makefile\n' > Makefile.ci
            make -f Makefile.ci -j"$(nproc)" all \
                 LINKING=DYNAMIC COMPILER=GNU \
                 CUDA_HOME=/usr/local/cuda \
                 EBROOTHDF5=/usr/lib/x86_64-linux-gnu/hdf5/serial \
                 EBROOTZLIB=/usr EBROOTFFTW=/usr EBROOTSZIP=/usr
          fi

      - name: Upload artifacts (CUDA Linux)
        uses: actions/upload-artifact@v4
        with:
          name: kspaceFirstOrder-cuda-linux-${{ matrix.cuda-version }}
          path: |
            repos/kspaceFirstOrder-cuda-linux/kspaceFirstOrder-CUDA
          if-no-files-found: error

      - name: Build diagnostics (CUDA Linux)
        if: failure()
        run: |
          echo "CUDA nvcc version:"; if command -v nvcc; then nvcc --version; fi
          echo "HDF5 libs:"; ldconfig -p | grep -i hdf5 || true
  macos-openmp:
    runs-on: macos-14
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Install dependencies (Homebrew)
        run: |
          brew update
          brew install hdf5 fftw zlib libomp

      - name: Build (OpenMP, macOS)
        run: |
          set -euxo pipefail
          H5=$(brew --prefix hdf5)
          FF=$(brew --prefix fftw)
          ZL=$(brew --prefix zlib)
          LO=$(brew --prefix libomp)
          # Choose FFTW OpenMP lib if available, otherwise fall back to threads lib
          if [ -f "$FF/lib/libfftw3f_omp.dylib" ] || [ -f "$FF/lib/libfftw3f_omp.a" ]; then
            FFTW_OMP_LIB="-lfftw3f_omp"
          else
            FFTW_OMP_LIB="-lfftw3f_threads"
          fi
          cd repos/kspaceFirstOrder-openmp-darwin
          make -j"$(sysctl -n hw.ncpu)" \
            HDF5_DIR="$H5" FFT_DIR="$FF" ZLIB_DIR="$ZL" LIBOMP_DIR="$LO" \
            LDLIBS="-lfftw3f $FFTW_OMP_LIB -lhdf5 -lhdf5_hl -lm -lz -lomp"

      - name: Smoke test (macOS)
        run: |
          set -e
          cd repos/kspaceFirstOrder-openmp-darwin
          ./kspaceFirstOrder-OMP --help

      - name: Upload artifacts (macOS)
        uses: actions/upload-artifact@v4
        with:
          name: kspaceFirstOrder-openmp-darwin-macos-latest
          path: |
            repos/kspaceFirstOrder-openmp-darwin/kspaceFirstOrder-OMP
          if-no-files-found: error

      - name: Build diagnostics (macOS)
        if: failure()
        run: |
          echo "Brew prefix:"; brew --prefix
          echo "libomp:"; ls -la $(brew --prefix libomp)/lib || true
          echo "fftw libs:"; ls -la $(brew --prefix fftw)/lib || true

  windows-cuda:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        cuda-version: ['13.0.0']
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Set up MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Install CUDA Toolkit (Windows)
        uses: N-Storm/cuda-toolkit@v0.2.27m
        with:
          cuda: ${{ matrix.cuda-version }}
          use-github-cache: true
          method: local
          linux-local-args: '["--toolkit"]'
          use-local-cache: false
          sub-packages: '[]'
          non-cuda-sub-packages: '[]'
          log-file-suffix: ${{ matrix.cuda-version }}.log.txt

      - name: Register CUDA MSBuild customizations
        shell: pwsh
        run: |
          $vsPath = & "${Env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -requires Microsoft.Component.MSBuild -property installationPath
          if (-not $vsPath) {
            throw "Failed to locate Visual Studio installation"
          }
          & "$vsPath\Common7\Tools\VsDevCmd.bat" -no_logo -arch=amd64 -host_arch=amd64 | Out-Null
          if (-not $env:CUDA_PATH) {
            throw "CUDA_PATH is not set after toolkit installation"
          }
          if (-not $env:VCTargetsPath) {
            $vcTargets = Join-Path $vsPath 'MSBuild/Microsoft/VC/v170'
            if (-not (Test-Path $vcTargets)) {
              throw "Unable to determine VCTargetsPath under $vsPath"
            }
            $env:VCTargetsPath = $vcTargets
          }
          $src = Join-Path $env:CUDA_PATH 'extras\visual_studio_integration\MSBuildExtensions'
          $dest = Join-Path $env:VCTargetsPath 'BuildCustomizations'
          Write-Host "Copying CUDA build customizations from $src to $dest"
          if (-not (Test-Path $src)) {
            throw "Expected MSBuildExtensions directory not found at $src"
          }
          New-Item -ItemType Directory -Path $dest -Force | Out-Null
          Copy-Item -Path (Join-Path $src 'CUDA*.props') -Destination $dest -Force
          Copy-Item -Path (Join-Path $src 'CUDA*.targets') -Destination $dest -Force

      - name: Install vcpkg and dependencies (HDF5 + zlib)
        shell: pwsh
        run: |
          $vcpkgRoot = "$env:RUNNER_TEMP\vcpkg"
          git clone --depth 1 https://github.com/microsoft/vcpkg $vcpkgRoot
          Write-Host "Bootstrapping vcpkg at: $vcpkgRoot"
          & "$vcpkgRoot\bootstrap-vcpkg.bat" -disableMetrics
          if ($LASTEXITCODE -ne 0) {
            throw "vcpkg bootstrap failed with exit code $LASTEXITCODE"
          }
          & "$vcpkgRoot\vcpkg.exe" install hdf5[szip]:x64-windows zlib:x64-windows
          echo "VCPKG_ROOT=$vcpkgRoot" | Out-File -FilePath $env:GITHUB_ENV -Append

      # Removed legacy alias step; project links vcpkg libs directly

      - name: Build (CUDA, Windows)
        shell: pwsh
        env:
          # Ensure HDF5 headers/libs are discoverable by MSBuild/Linker
          INCLUDE: ${{ env.VCPKG_ROOT }}\installed\x64-windows\include;${{ env.INCLUDE }}
          LIB: ${{ env.VCPKG_ROOT }}\installed\x64-windows\lib;${{ env.LIB }}
        run: |
          & msbuild .\repos\kspaceFirstOrder-cuda-windows\kspaceFirstOrder-CUDA.vcxproj `
              /p:Configuration=Release /p:Platform=x64 /m

      - name: Upload artifacts (CUDA Windows)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: kspaceFirstOrder-cuda-windows-${{ matrix.cuda-version }}
          path: |
            repos/kspaceFirstOrder-cuda-windows/x64/Release/kspaceFirstOrder-CUDA.exe
          if-no-files-found: error

      - name: Build diagnostics (CUDA Windows)
        if: failure()
        shell: pwsh
        run: |
          nvcc --version || $true
          & msbuild -version || $true
          Get-ChildItem -Recurse -Filter *.targets "C:\Program Files (x86)\Microsoft Visual Studio" -ErrorAction SilentlyContinue | Select-Object -First 5 | ForEach-Object { $_.FullName }

  windows-openmp:
    runs-on: windows-latest
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Set up MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Install vcpkg and deps (static + OpenMP)
        shell: pwsh
        run: |
          $vcpkgRoot = "$env:RUNNER_TEMP\vcpkg"
          git clone --depth 1 https://github.com/microsoft/vcpkg $vcpkgRoot
          & "$vcpkgRoot\bootstrap-vcpkg.bat"
          & "$vcpkgRoot\vcpkg.exe" install `
            hdf5[szip]:x64-windows-static `
            libaec:x64-windows-static `
            zlib:x64-windows-static `
            fftw3[openmp]:x64-windows-static
          echo "VCPKG_ROOT=$vcpkgRoot" | Out-File -FilePath $env:GITHUB_ENV -Append
          $manual = Join-Path $vcpkgRoot "installed\x64-windows-static\lib\manual-link"
          $primary = Join-Path $vcpkgRoot "installed\x64-windows-static\lib"

          function Resolve-LibraryName {
            param(
              [string[]]$Candidates,
              [string]$Default
            )
            foreach ($candidate in $Candidates) {
              if (Test-Path (Join-Path $manual $candidate)) { return $candidate }
              if (Test-Path (Join-Path $primary $candidate)) { return $candidate }
            }
            Write-Warning "Unable to locate ${Candidates[0]} variants; defaulting to $Default"
            return $Default
          }

          $libaec = Resolve-LibraryName -Candidates @('aec-static.lib','szip-static.lib','libaec.lib','aec.lib','szip.lib') -Default 'aec-static.lib'
          echo "LIBAEC_LIB=$libaec" | Out-File -FilePath $env:GITHUB_ENV -Append

          $hdf5Lib   = Resolve-LibraryName -Candidates @('hdf5-static.lib','libhdf5.lib','hdf5.lib') -Default 'hdf5-static.lib'
          $hdf5HlLib = Resolve-LibraryName -Candidates @('hdf5_hl-static.lib','libhdf5_hl.lib','hdf5_hl.lib') -Default 'hdf5_hl-static.lib'
          echo "HDF5_LIB=$hdf5Lib" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "HDF5_HL_LIB=$hdf5HlLib" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Build (OpenMP, Windows)
        shell: pwsh
        env:
          INCLUDE: ${{ env.VCPKG_ROOT }}\installed\x64-windows-static\include;${{ env.INCLUDE }}
          LIB: ${{ env.VCPKG_ROOT }}\installed\x64-windows-static\lib;${{ env.VCPKG_ROOT }}\installed\x64-windows-static\lib\manual-link;${{ env.LIB }}
        run: |
          & msbuild .\repos\kspaceFirstOrder-openmp-windows\kspaceFirstOrder-OMP.vcxproj `
              /p:Configuration=Release /p:Platform=x64 /m

      - name: Upload artifacts (OpenMP Windows)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: kspaceFirstOrder-openmp-windows-windows-latest
          path: |
            repos/kspaceFirstOrder-openmp-windows/x64/Release/kspaceFirstOrder-OMP.exe
          if-no-files-found: error

      - name: Build diagnostics (OpenMP Windows)
        if: failure()
        shell: pwsh
        run: |
          & msbuild -version || $true
