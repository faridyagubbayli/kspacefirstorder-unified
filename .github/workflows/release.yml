name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-matrix:
    strategy:
      matrix:
        include:
          # Linux builds
          - os: ubuntu-latest
            name: linux-openmp
            cmake_flags: "-DUSE_CUDA=OFF -DUSE_OPENMP=ON"
            artifact_path: "build/src/kspaceFirstOrder"
            setup_cuda: false
          - os: ubuntu-latest
            name: linux-cuda
            cmake_flags: "-DUSE_CUDA=ON -DUSE_OPENMP=OFF"
            artifact_path: "build/src/kspaceFirstOrder"
            setup_cuda: true
          - os: ubuntu-latest
            name: linux-dual
            cmake_flags: "-DUSE_CUDA=ON -DUSE_OPENMP=ON"
            artifact_path: "build/src/kspaceFirstOrder"
            setup_cuda: true
          
          # macOS builds
          - os: macos-latest
            name: macos-openmp
            cmake_flags: "-DUSE_CUDA=OFF -DUSE_OPENMP=ON"
            artifact_path: "build/src/kspaceFirstOrder"
            setup_cuda: false
          - os: macos-latest
            name: macos-core
            cmake_flags: "-DUSE_CUDA=OFF -DUSE_OPENMP=OFF"
            artifact_path: "build/src/kspaceFirstOrder"
            setup_cuda: false
          
          # Windows builds
          - os: windows-latest
            name: windows-openmp
            cmake_flags: "-DUSE_CUDA=OFF -DUSE_OPENMP=ON"
            artifact_path: "build/src/Release/kspaceFirstOrder.exe"
            setup_cuda: false
          - os: windows-latest
            name: windows-cuda
            cmake_flags: "-DUSE_CUDA=ON -DUSE_OPENMP=OFF"
            artifact_path: "build/src/Release/kspaceFirstOrder.exe"
            setup_cuda: true
          - os: windows-latest
            name: windows-dual
            cmake_flags: "-DUSE_CUDA=ON -DUSE_OPENMP=ON"
            artifact_path: "build/src/Release/kspaceFirstOrder.exe"
            setup_cuda: true

    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.name }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install CUDA Toolkit
      if: matrix.setup_cuda
      uses: Jimver/cuda-toolkit@v0.2.14
      with:
        cuda: '12.3.2'
    
    - name: Install Linux dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake
    
    - name: Configure CMake
      run: cmake -B build ${{ matrix.cmake_flags }} -DCMAKE_BUILD_TYPE=Release
    
    - name: Build (Unix)
      if: runner.os != 'Windows'
      run: |
        if [ "$RUNNER_OS" = "Linux" ]; then
          cmake --build build -j$(nproc)
        else
          cmake --build build -j$(sysctl -n hw.ncpu)
        fi
      shell: bash
    
    - name: Build (Windows)
      if: runner.os == 'Windows'
      run: cmake --build build --config Release -j
    
    - name: Create archive (Unix)
      if: runner.os != 'Windows'
      run: |
        mkdir -p release
        cp ${{ matrix.artifact_path }} release/
        tar -czf kspaceFirstOrder-${{ matrix.name }}.tar.gz -C release .
    
    - name: Create archive (Windows)
      if: runner.os == 'Windows'
      run: |
        mkdir release
        copy "${{ matrix.artifact_path }}" release\
        Compress-Archive -Path release\* -DestinationPath kspaceFirstOrder-${{ matrix.name }}.zip
      shell: powershell
    
    - name: Upload Unix artifacts
      if: runner.os != 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: kspaceFirstOrder-${{ matrix.name }}
        path: kspaceFirstOrder-${{ matrix.name }}.tar.gz
    
    - name: Upload Windows artifacts
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: kspaceFirstOrder-${{ matrix.name }}
        path: kspaceFirstOrder-${{ matrix.name }}.zip

  create-release:
    needs: build-matrix
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/*/kspaceFirstOrder-*.tar.gz
          artifacts/*/kspaceFirstOrder-*.zip
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
